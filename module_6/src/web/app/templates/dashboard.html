<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Graduate Admissions Query Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
</head>
<body data-pull-running="{{ 'true' if pull_in_progress else 'false' }}">
  <!-- Header: title, tech badges, and action buttons -->
  <header>
    <h1>Graduate Admissions Query Dashboard</h1>
    <p>Live PostgreSQL snapshots of GradCafe applicant trends, rendered as a single, stylized Flask page.</p>
    <div class="meta">
      <span>PostgreSQL</span>
      <span>Flask</span>
      <span>11 Queries</span>
    </div>
    <!-- Pull Data controls -->
    <section class="pull-data">
      <div>
        <h2>Pull Data</h2>
        <p>Fetches GradCafe survey pages starting after the last page pulled and appends any new entries to the database.</p>
      </div>
      <form id="pull-data-form" action="{{ url_for('dashboard.pull_data') }}" method="post">
        <button data-testid="pull-data-btn" id="pull-data-button" type="submit" class="pull-button" {% if pull_in_progress %}disabled aria-disabled="true"{% endif %}>
          Pull Data
        </button>
      </form>
    </section>
    <!-- Live pull progress panel -->
    <section class="pull-progress" aria-live="polite">
      <div class="progress-title">Pull Status</div>
      <div id="pull-status-message" class="progress-message">{{ pull_state.message }}</div>
      <div id="pull-status-counts" class="progress-counts"></div>
      <div class="progress-hint">Progress updates in batches of 100 records.</div>
    </section>
    <!-- Update Analysis controls -->
    <section class="pull-data">
      <div>
        <h2>Update Analysis</h2>
        <p>Refreshes the dashboard so the latest database updates are reflected in the results.</p>
      </div>
      <div class="update-actions">
        <form id="update-analysis-form" action="{{ url_for('dashboard.update_analysis') }}" method="post">
          <button data-testid="update-analysis-btn" id="update-analysis-button" type="submit" class="pull-button" {% if pull_in_progress %}disabled aria-disabled="true"{% endif %}>
            Update Analysis
          </button>
        </form>
        {% if pull_in_progress %}
          <div id="update-analysis-note" class="action-note">Pull Data is running, so this action is temporarily disabled.</div>
        {% endif %}
      </div>
    </section>
    <!-- Flash-style status banner after redirects -->
    {% if pull_status and pull_message %}
      <div class="pull-status {{ pull_status }}">{{ pull_message }}</div>
    {% endif %}
  </header>
  <!-- Main results grid -->
  <main>
    <section class="grid">
      {% for item in results %}
      <article class="card">
        <h2>{{ item.title }}</h2>
        {% if item.error %}
          <div class="error">{{ item.error }}</div>
        {% else %}
          <div class="result">
            {% if item.display %}
              <strong>Answer:</strong> {{ item.display }}
            {% elif item.rows|length == 1 and item.columns|length == 1 %}
              <strong>{{ item.columns[0].replace('_', ' ').title() }}:</strong> {{ item.rows[0][0] }}
            {% else %}
              <table>
                <thead>
                  <tr>
                    {% for col in item.columns %}
                    <th>{{ col.replace('_', ' ').title() }}</th>
                    {% endfor %}
                  </tr>
                </thead>
                <tbody>
                  {% for row in item.rows %}
                  <tr>
                    {% for value in row %}
                    <td>{{ value }}</td>
                    {% endfor %}
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% endif %}
          </div>
        {% endif %}
      </article>
      {% endfor %}
    </section>
  </main>
  <!-- Footer note -->
  <footer>
    Data refreshes on page load. Run the Flask app to view current results.
  </footer>
  <!-- Initial pull state + polling script -->
  <script id="pull-state" type="application/json">{{ pull_state.progress | tojson }}</script>
  <script>
    const pullStatusMessage = document.getElementById('pull-status-message');
    const pullStatusCounts = document.getElementById('pull-status-counts');
    const pullStateJson = document.getElementById('pull-state');
    const pullDataForm = document.getElementById('pull-data-form');
    const updateAnalysisForm = document.getElementById('update-analysis-form');
    const pullDataButton = document.getElementById('pull-data-button');
    const updateAnalysisButton = document.getElementById('update-analysis-button');
    const updateAnalysisNote = document.getElementById('update-analysis-note');

    function renderCounts(progress) {
      if (!progress) {
        pullStatusCounts.textContent = '';
        return;
      }
      const parts = [];
      if (progress.pages_scraped !== undefined && progress.pages_scraped !== null) {
        parts.push(`Pages: ${progress.pages_scraped}`);
      }
      if (progress.processed !== undefined && progress.processed !== null) {
        parts.push(`Processed: ${progress.processed}`);
      }
      if (progress.inserted !== undefined && progress.inserted !== null) {
        parts.push(`Inserted: ${progress.inserted}`);
      }
      if (progress.duplicates !== undefined && progress.duplicates !== null) {
        parts.push(`Duplicates: ${progress.duplicates}`);
      }
      if (progress.missing_urls !== undefined && progress.missing_urls !== null) {
        parts.push(`Missing URLs: ${progress.missing_urls}`);
      }
      if (progress.errors !== undefined && progress.errors !== null) {
        parts.push(`Errors: ${progress.errors}`);
      }
      pullStatusCounts.textContent = parts.join(' | ');
    }

    function updateAnalysisAvailability(isRunning) {
      if (!updateAnalysisButton) return;
      if (isRunning) {
        updateAnalysisButton.setAttribute('disabled', '');
        updateAnalysisButton.setAttribute('aria-disabled', 'true');
        if (updateAnalysisNote) {
          updateAnalysisNote.style.display = 'block';
        }
      } else {
        updateAnalysisButton.removeAttribute('disabled');
        updateAnalysisButton.removeAttribute('aria-disabled');
        if (updateAnalysisNote) {
          updateAnalysisNote.style.display = 'none';
        }
      }
    }

    async function pollPullStatus() {
      try {
        const response = await fetch("{{ url_for('dashboard.pull_status') }}");
        if (!response.ok) return;
        const data = await response.json();
        if (pullStatusMessage && data.message) {
          pullStatusMessage.textContent = data.message;
        }
        renderCounts(data.progress);
        updateAnalysisAvailability(Boolean(data.running));
      } catch (error) {
        // Ignore polling errors.
      }
    }

    async function postAction(formEl) {
      if (!formEl) return;
      try {
        const response = await fetch(formEl.action, { method: 'POST' });
        const payload = await response.json();
        if (pullStatusMessage && payload.message) {
          pullStatusMessage.textContent = payload.message;
        }
        if (response.status === 409) {
          updateAnalysisAvailability(true);
          return;
        }
        if (formEl === pullDataForm && pullDataButton) {
          pullDataButton.setAttribute('disabled', '');
          pullDataButton.setAttribute('aria-disabled', 'true');
        }
        if (payload.pull_state && payload.pull_state.progress) {
          renderCounts(payload.pull_state.progress);
        }
        if (formEl === updateAnalysisForm && response.ok) {
          window.location.reload();
        }
      } catch (error) {
        if (pullStatusMessage) {
          pullStatusMessage.textContent = 'Request failed. Please try again.';
        }
      }
    }

    if (pullStateJson) {
      try {
        renderCounts(JSON.parse(pullStateJson.textContent));
      } catch (error) {
        renderCounts(null);
      }
    }
    const initialPullRunning = document.body.dataset.pullRunning === 'true';
    updateAnalysisAvailability(initialPullRunning);
    if (pullDataForm) {
      pullDataForm.addEventListener('submit', (event) => {
        event.preventDefault();
        postAction(pullDataForm);
      });
    }
    if (updateAnalysisForm) {
      updateAnalysisForm.addEventListener('submit', (event) => {
        event.preventDefault();
        postAction(updateAnalysisForm);
      });
    }
    setInterval(pollPullStatus, 2000);
  </script>
</body>
</html>

